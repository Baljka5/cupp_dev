    <link href="/static/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/static/css/bootstrap_limitless.min.css" rel="stylesheet" type="text/css">
    <script src="/static/js/main/bootstrap.bundle.min.js"></script>
{% extends "base.html" %}
{% block header %}
{% endblock %}

{% block content %}


    <div class="p-0 overflow-hidden max-h-[100vh]">

        <div id="map" class="h-screen top-[55px]"></div>
        <form id="form_filter">
            <div id="id_type_filter" class="bg-white py-2 shadow-sm text-xs">
                <div class="d-flex justify-content-between align-items-center mt-2 mb-3 px-3">
                    <div class="">
                        <span class="font-weight-bold">Point type</span>
                    </div>
                    <div>
                        <a href="#" id="id_unselect_all" class="font-medium text-red-600 hover:text-red-700">Unselect All</a>
                        <a href="#" id="id_select_all" class="font-medium text-green-600 hover:text-green-700" style="display:none">Select All</a>
                    </div>
                </div>
                                <!-- {% for type in types %}
                                    <label class="d-block">
                                        <input type="checkbox" value="{{ type.type_cd }}" id="id_{{ type.type_cd }}" name="type"
                                               class="mr-1 type-checkbox"
                                               checked>
                                        {{ type.type_name }}
                                    </label>
                               w {% endfor %} -->
                {% for k,v in types %}
                                        <!-- {% if k != 'PP' %} -->

                    <div class="flex items-center justify-between  mb-2 cursor-pointer px-3 bt-2">
                        
                        <label for="id_{{ k }}" class="cursor-pointer flex items-center ms-0 mb-0 text-xs font-normal text-gray-900">
                            <div  class="point-marker-img">
                                <img src="/static/images/ui/marker-{{ k }}.png" alt="marker-{{ k }}">
                            </div>
                            {{ v }}
                        </label>

                        <input name="type" checked id="id_{{ k }}" type="checkbox" value="{{ k }}" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-purple-500 focus:ring-2  type-checkbox" >
                    </div>
                                        <!-- {% endif %} -->
                {% endfor %}

                
                <hr class="mb-2 mt-3">
                <div class="pt-2 px-3 mb-2">
                    <span class="font-weight-bold">Point grade</span>
                </div>
                <div class="flex flex-wrap items-center justify-between px-3 py-1 text-sm">
                    {% for k,v in grades %}
                        <label class="flex items-center justify-between  mb-0 ">
                            <input type="checkbox" value="{{ k }}" id="grade_{{ k }}" name="grade" class="mr-1 grade-tag-check type-checkbox hidden" checked >
                            <label class="mb-0  grade-tag-label cursor-pointer" for="grade_{{ k }}">Grade {{ v }}</label>
                        </label>
                    {% endfor %}
                </div>

                <hr class="mb-2 mt-3 ">
                <!-- <label class="d-block">
                    <input type="checkbox" value="radius" id="id_radius" class="mr-1 type-checkbox">
                    Show radius
                </label> -->
                <div class="pt-2 px-3 mb-2">
                    <span class="font-weight-bold">Point radius</span>
                </div>
                <div class="flex items-center justify-between pe-4 mb-2 cursor-pointer py-2 px-3 hover:bg-gray-300">
                        
                    <label for="id_radius" class="w-full cursor-pointer flex items-center  mb-0 text-xs font-medium text-gray-900">
                        <i class="icon-location4 mr-1 text-red-500"></i>
                        Show radius 
                    </label>

                    <input name="type" id="id_radius" type="checkbox" value="radius" class="w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-purple-500 focus:ring-2  type-checkbox" >
                </div>
            </div>

            <div id="second_filter" class="bg-white p-2 shadow-sm font-size-sm hidden d-md-block">
                <label class="flex items-center justify-start">
                    <!-- <input type="checkbox" value="1" name="availability" class="mr-1 type-checkbox"> -->
                    <input type="checkbox" value="1" name="availability" class="me-2 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded-sm focus:ring-purple-500 focus:ring-2 type-checkbox" >
                    <span class="ms-2">
                        Now available
                    </span>
                </label>
                <hr class="mb-2 mt-1">
                <label>
                    Available date:
                </label>
                <input type="text" id="map_daterange" name="available_date"
                       class="form-control form-control-sm daterange-basic daterangefilter">
                <label class="mt-2">
                    Created date:
                </label>
                <input type="text" name="created_date"
                       class="form-control form-control-sm daterange-basic daterangefilter">
                <label class="mt-2">
                    Created by:
                </label>
                <select name="created_by" id="filter_user" class="form-control form-control-sm select">
                    <option value="">---------</option>
                    {% for row in users %}
                        <option value="{{ row.id }}">
                            {% if row.first_name and row.last_name %}
                                {{ row.last_name.0 }}.{{ row.first_name }}
                            {% elif row.first_name %}
                                {{ row.first_name }}
                            {% else %}
                                {{ row.username }}
                            {% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>


            <div id="third_filter" class="bg-white p-2 shadow-sm font-size-sm hidden d-md-block">
                <label>
                    Lat/Lon:
                </label>
                <input type="text" id="search_latlon" name="latlon" placeholder="47.915711 106.891544"
                       class="form-control form-control-sm"><br>
                <label>
                    Store ID:
                </label>
                <input type="text" id="search_store_id" name="storeid" placeholder="Search Store ID"
                       class="form-control form-control-sm"><br>
                <div id="nearby_branches" class="bg-white p-2 shadow-sm font-size-sm hidden"></div>
                <br>

                                <!-- <label class="d-block">
                                    <input type="text" id="id_filter_size" name="size"
                                           class="form-control ion-height-helper map-digit-filter" data-fouc>
                                    <div class="mt-1">Size</div>
                                </label>
                                <hr class="mb-1 mt-2">
                                <label class="d-block">
                                    <input type="text" id="id_filter_base_rent_rate" name="base_rent_rate"
                                           class="form-control ion-height-helper map-digit-filter"
                                           data-fouc>
                                    <div class="mt-1">Base rent rate</div>
                                </label>
                                <hr class="mb-1 mt-2">
                                <label class="d-block">
                                    <input type="text" id="id_filter_max_rent_rate" name="max_rent_rate"
                                           class="form-control ion-height-helper map-digit-filter"
                                           data-fouc>
                                    <div class="mt-1">Maximum rent rate</div>
                                </label> -->
            </div>
        </form>

        <div id="id_map_data" class="hidden">
            {% for point in points %}
                <ul data-lat="{{ point.lat }}"
                    data-lon="{{ point.lon }}"
                    data-title="{{ point.name }}"
                    data-id="{{ point.id }}"
                    data-type="{{ point.type }}"
                    data-radius="{{ point.radius|default:'' }}"
                >
                </ul>
            {% endfor %}
        </div>

    </div>
    <style>
        /* Highlight the clicked branch with #673ab7 */
        .nearby-branch.active {
            background-color: #673ab7 !important;
            color: white !important;
            font-weight: bold;
            border-radius: 4px;
            padding: 8px;
        }

        /* Hover effect for better visibility */
        .nearby-branch:hover {
            background-color: #9575cd !important;
            color: white !important;
            cursor: pointer;
        }

        #nearby_branches {
            max-height: 350px;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
    </style>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBls3a4Jl1HY60FhdpaSPxBrVBg2D4EYAY&callback=initMap"
            type="text/javascript"></script>
    <script>
        $(function () {
            $('.type-checkbox, #map_daterange, #filter_user').change(function () {
                maploadList(map, true);
            });

            $('#id_select_all').click(function () {
                $('#id_select_all').css('display',"none");
                $('.type-checkbox[name="type"]').prop('checked', true);
                $('#id_unselect_all').css('display',"block");
                maploadList(map, true);
            });
            $('#id_unselect_all').click(function () {
                $('#id_unselect_all').css('display',"none");
                $('.type-checkbox[name="type"]').prop('checked', false);
                $('#id_select_all').css('display',"block");
                maploadList(map, true);
            });

            $('.daterangefilter').daterangepicker({
                applyClass: 'bg-purple btn-sm',
                cancelClass: 'btn-light btn-sm',
                autoUpdateInput: false,
                locale: {
                    format: 'YYYY/MM/DD',
                    cancelLabel: 'Clear'
                }
            });

            $('.daterangefilter').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('YYYY/MM/DD') + ' - ' + picker.endDate.format('YYYY/MM/DD'));
                maploadList(map, true);
            });

            $('.daterangefilter').on('cancel.daterangepicker', function (ev, picker) {
                $(this).val('');
                maploadList(map, true);
            });

            $('#id_filter_size').ionRangeSlider({
                type: 'double',
                min: 0,
                max: 300,
                from: 0,
                to: 300,
                onFinish: function (data) {
                    maploadList(map, true);
                },
            });

            $('#id_filter_base_rent_rate').ionRangeSlider({
                type: 'double',
                min: 0,
                max: 20000000,
                from: 0,
                to: 20000000,
                onFinish: function (data) {
                    maploadList(map, true);
                },
            });

            $('#id_filter_max_rent_rate').ionRangeSlider({
                type: 'double',
                min: 0,
                max: 20000000,
                from: 0,
                to: 20000000,
                onFinish: function (data) {
                    maploadList(map, true);
                },
            });
        });

        function searchByLatLonCombined() {
            var input = $('#search_latlon').val().trim();
            var parts = input.split(/\s+/); // Split by whitespace
            if (parts.length === 2) {
                var lat = parseFloat(parts[0]);
                var lon = parseFloat(parts[1]);

                if (!isNaN(lat) && !isNaN(lon)) {
                    var latLng = new google.maps.LatLng(lat, lon);
                    map.setCenter(latLng);
                    map.setZoom(15); // Adjust zoom level as needed

                    // Optional: Place a temporary marker at the searched location
                    var searchMarker = new google.maps.Marker({
                        position: latLng,
                        map: map,
                        title: "Search Result"
                    });

                    // Optionally, clear the marker after some time or based on some user action
                    setTimeout(function () {
                        searchMarker.setMap(null);
                    }, 3000); // Clears marker after 3 seconds
                } else {
                    alert("Please enter valid latitude and longitude values.");
                }
            } else {
                alert("Please enter the coordinates in the format: 'latitude longitude'.");
            }
        }

        $('#search_latlon').on('keypress', function (e) {
            if (e.which == 13) { // Enter key is pressed
                searchByLatLonCombined();
                return false; // Prevent form submission
            }
        });

        // If you have a search button:
        $('#your_search_button_id').click(function () {
            searchByLatLonCombined();
        });

        $(document).ready(function () {
            let currentMarker = null; // Store the last clicked marker
            let searchMarker = null;  // Store the searched store marker
            let timeoutId = null;      // Timeout for clearing markers

            $('#search_store_id').on('change', function () {
                var storeId = $(this).val().trim();
                if (storeId) {
                    $.ajax({
                        url: "{% url 'get_store_location' %}",  // Django URL pattern
                        type: "GET",
                        data: {store_id: storeId},
                        success: function (response) {
                            if (response.lat && response.lon) {
                                var latLng = new google.maps.LatLng(response.lat, response.lon);
                                map.setCenter(latLng);
                                map.setZoom(15);

                                // Remove previous markers
                                if (searchMarker) searchMarker.setMap(null);
                                if (currentMarker) currentMarker.setMap(null);
                                if (timeoutId) clearTimeout(timeoutId);

                                // Add new marker for the searched store
                                searchMarker = new google.maps.Marker({
                                    position: latLng,
                                    map: map,
                                    title: `Store ID: ${storeId}`,
                                });

                                // Auto-remove marker after 3 seconds
                                timeoutId = setTimeout(function () {
                                    if (searchMarker) searchMarker.setMap(null);
                                }, 3000);

                                // Display nearby CU branches
                                if (response.nearby_branches.length > 0) {
                                    var nearbyHTML = '<h6>Nearby CU Branches</h6><ul class="list-group">';
                                    response.nearby_branches.forEach(branch => {
                                        nearbyHTML += `<li class="list-group-item nearby-branch"
                        data-lat="${branch.lat}"
                        data-lon="${branch.lon}"
                        data-id="${branch.store_id}">
                        <strong>${branch.store_id}</strong> - ${branch.store_name}
                    </li>`;
                                    });
                                    nearbyHTML += '</ul>';
                                    $('#nearby_branches').html(nearbyHTML).removeClass('hidden');

                                    // Click event for nearby branches
                                    $('.nearby-branch').click(function () {
                                        var lat = $(this).data('lat');
                                        var lon = $(this).data('lon');
                                        var storeId = $(this).data('id');
                                        var latLng = new google.maps.LatLng(lat, lon);

                                        // Remove previous branch marker
                                        if (currentMarker) {
                                            currentMarker.setMap(null);
                                        }
                                        if (timeoutId) clearTimeout(timeoutId);

                                        // Add marker for the clicked branch
                                        currentMarker = new google.maps.Marker({
                                            position: latLng,
                                            map: map,
                                            title: `Store ID: ${storeId}`,
                                        });

                                        // Center map on clicked branch
                                        map.setCenter(latLng);
                                        map.setZoom(15);

                                        // Remove active class from other branches and add to clicked one
                                        $('.nearby-branch').removeClass('active');
                                        $(this).addClass('active');

                                        // Auto-remove marker after 3 seconds
                                        timeoutId = setTimeout(function () {
                                            if (currentMarker) currentMarker.setMap(null);
                                        }, 3000);
                                    });
                                } else {
                                    $('#nearby_branches').addClass('hidden');
                                }
                            } else {
                                alert("CU Store ID not found.");
                            }
                        },
                        error: function () {
                            alert("Error fetching CU store location.");
                        }
                    });
                }
            });
        });
    </script>
{% endblock %}